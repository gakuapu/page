<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XKL20YHCTB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-XKL20YHCTB');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜èªå¸³ä¸€è¦§ï½œMyå˜èªå¸³</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --bg-body: #F8FAFC;
            --bg-surface: #FFFFFF;
            --text-main: #0F172A;
            --text-sub: #64748B;
            --border: #E2E8F0;
            --primary: #3B82F6;
            --primary-light: #60A5FA;
            --danger: #EF4444;
            --radius: 18px; /* index.htmlã«åˆã‚ã›ã¦èª¿æ•´ */
            --status-green: #10B981;
            --status-yellow: #F59E0B;
            --status-red: #EF4444;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            padding-bottom: 80px;
        }

        header {
            background: var(--bg-surface);
            padding: 14px 20px; /* ä½™ç™½ã‚’è©°ã‚ã‚‹ */
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: 40px 1fr auto;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-actions { display: flex; gap: 8px; }

        .back-btn, .icon-btn {
            background: none;
            border: none;
            font-size: 1.4rem; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
            color: var(--text-sub);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
        }
        
        .back-btn:hover, .icon-btn:hover { color: var(--primary); background: #F1F5F9; }

        h1 { font-size: 1rem; font-weight: 800; margin: 0; text-align: center; }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        .limit-info { text-align: right; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 12px; }

        .deck-list {
            display: grid;
            gap: 14px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’è©°ã‚ã‚‹ */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            padding-bottom: 40px;
        }

        .deck-card {
            background: var(--bg-surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 16px; /* ã‚«ãƒ¼ãƒ‰å†…ä½™ç™½ã‚’ç¸®å° */
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 140px; /* é«˜ã•èª¿æ•´ */
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .deck-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .deck-card:active { transform: scale(0.98); }

        .deck-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .deck-title { font-size: 1rem; font-weight: 800; margin: 0; color: var(--text-main); line-height: 1.4; }
        .deck-meta { font-size: 0.8rem; color: var(--text-sub); margin-top: 4px; }

        .deck-menu { display: flex; gap: 4px; }
        .deck-menu-btn { background: none; border: none; color: #CBD5E1; font-size: 1.2rem; cursor: pointer; padding: 4px; border-radius: 4px; }
        .deck-menu-btn:hover { color: var(--danger); background: #FEF2F2; }
        
        .status-preview {
            display: flex; gap: 10px; font-size: 0.75rem; font-weight: 700;
            color: var(--text-sub); background: #F8FAFC; padding: 6px 10px;
            border-radius: 8px; width: fit-content; margin-top: auto;
        }
        .status-item { display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-red { background: var(--status-red); }
        .dot-yellow { background: var(--status-yellow); }
        .dot-green { background: var(--status-green); }

        .mini-edit-btn {
            position: absolute; bottom: 16px; right: 16px;
            background: white; border: 1px solid var(--border); color: var(--text-sub);
            width: 34px; height: 34px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s; z-index: 10;
        }
        .mini-edit-btn:hover { color: var(--primary); border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }

        /* è¿½åŠ ã‚«ãƒ¼ãƒ‰ï¼ˆé€šå¸¸ï¼‰ */
        .add-card {
            border: 2px dashed var(--border); background: transparent;
            justify-content: center; align-items: center; color: var(--primary);
            font-weight: 700; gap: 8px; min-height: 140px;
            display: flex; flex-direction: column;
        }
        .add-card:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        
        /* è¿½åŠ ã‚«ãƒ¼ãƒ‰ï¼ˆä¸Šé™åˆ°é”æ™‚ï¼‰ */
        .add-card-disabled {
            border: 2px dashed #CBD5E1; background: #F8FAFC;
            justify-content: center; align-items: center; color: #94A3B8;
            gap: 8px; min-height: 140px;
            display: flex; flex-direction: column; cursor: pointer;
        }
        .add-card-disabled:hover { background: #F1F5F9; }
        
        .add-icon { font-size: 1.8rem; }
        .add-text-sub { font-size: 0.75rem; font-weight: normal; margin-top: -4px; }

        /* --- ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³èª¬æ˜æ–‡ --- */
        .about-details {
            margin-top: 32px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: white;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .about-summary {
            padding: 14px 16px;
            font-weight: 700;
            cursor: pointer;
            background: #F8FAFC;
            color: var(--text-main);
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        .about-summary:hover { background: #EFF6FF; }
        .about-summary::-webkit-details-marker { display: none; }
        .about-summary::after { content: '+'; font-size: 1.1rem; color: var(--text-sub); font-weight: 400; }
        details[open] .about-summary::after { content: '-'; }
        
        .about-content {
            padding: 20px;
            font-size: 0.85rem;
            line-height: 1.7;
            color: var(--text-main);
            border-top: 1px solid var(--border);
            animation: fadeIn 0.3s;
        }
        .about-h3 {
            font-size: 0.95rem;
            font-weight: 800;
            margin: 20px 0 10px 0;
            color: var(--primary);
            display: flex; align-items: center; gap: 8px;
        }
        .about-h3:first-child { margin-top: 0; }
        .about-ul { margin: 0; padding-left: 20px; }
        .about-li { margin-bottom: 8px; }
        .about-strong { color: var(--danger); font-weight: 700; background: #FEF2F2; padding: 2px 6px; border-radius: 4px; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 200; display: none;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 20px; padding: 24px; max-height: 80vh; display: flex; flex-direction: column; }
        
        .modal-title { margin: 0 0 16px 0; font-size: 1.1rem; color: var(--text-main); }
        .modal-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; margin-bottom: 8px; }
        .input-hint { font-size: 0.75rem; color: var(--text-sub); margin-bottom: 20px; text-align: right; }
        
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }
        .btn-modal { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 0.9rem; }
        .btn-cancel { background: #F1F5F9; color: var(--text-sub); }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-confirm:disabled { background: #CBD5E1; cursor: not-allowed; }

        /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒªã‚¹ãƒˆ */
        .import-list {
            overflow-y: auto; border: 1px solid var(--border); border-radius: 12px;
            padding: 0; margin: 0; list-style: none; flex-grow: 1;
        }
        .import-item {
            display: flex; align-items: center; padding: 10px 14px; border-bottom: 1px solid var(--border);
            transition: background 0.1s; cursor: pointer;
        }
        .import-item:last-child { border-bottom: none; }
        .import-item:hover { background: #F8FAFC; }
        
        .import-checkbox { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; }
        .import-info { flex-grow: 1; }
        .import-title { font-weight: 700; font-size: 0.95rem; display: block; }
        .import-meta { font-size: 0.75rem; color: var(--text-sub); }
        
        .import-status {
            background: #EFF6FF; color: var(--primary); padding: 8px 12px;
            border-radius: 8px; font-size: 0.85rem; margin-bottom: 12px;
            display: flex; justify-content: space-between; font-weight: 600;
        }
        .import-warning { color: var(--danger); font-size: 0.8rem; margin-top: 4px; display: none; text-align: right; }
        
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }
    </style>
</head>

<body>
    <header>
        <button class="back-btn" onclick="navigateTo('index.html')"><i class="ph-bold ph-caret-left"></i></button>
        <h1>å˜èªå¸³ä¸€è¦§</h1>
        <div class="header-actions">
            <button class="icon-btn" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—" onclick="exportBackup()"><i class="ph-bold ph-download-simple"></i></button>
            <button class="icon-btn" title="å¾©å…ƒ(ã‚¤ãƒ³ãƒãƒ¼ãƒˆ)" onclick="triggerImport()"><i class="ph-bold ph-upload-simple"></i></button>
            <button class="icon-btn" title="å…¨ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›" onclick="exportAllCSV()"><i class="ph-bold ph-file-csv"></i></button>
        </div>
    </header>

    <input type="file" id="import-file" style="display:none" accept=".json" onchange="readBackupFile(this)">

    <main class="container">
        <div class="limit-info">ä½œæˆæ¸ˆã¿: <span id="deck-count-disp">0</span> / 10</div>
        <div id="deck-list" class="deck-list"></div>

        <details class="about-details">
            <summary class="about-summary">ğŸ“˜ Myå˜èªå¸³ã«ã¤ã„ã¦ãƒ»ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨å¼•ãç¶™ã</summary>
            <div class="about-content">
                <h3 class="about-h3">ã©ã‚“ãªã‚¢ãƒ—ãƒªï¼Ÿ</h3>
                <p>Myå˜èªå¸³ã¯ã€<strong>ã€Œä¼šå“¡ç™»éŒ²ãªã—ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã€</strong>ã§ã™ãã«ä½¿ãˆã‚‹ã€ã‚ãªãŸã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå­¦ç¿’ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ã€Œä½™è¨ˆãªæ©Ÿèƒ½ã‚’å‰Šãè½ã¨ã—ã€å­¦ç¿’ã«é›†ä¸­ã§ãã‚‹ã“ã¨ã€ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚</p>
                <h3 class="about-h3">âœ¨ ä¸»ãªç‰¹å¾´</h3>
                <ul class="about-ul">
                    <li class="about-li"><b>ğŸš€ 0ç§’ã§é–‹å§‹</b>: é¢å€’ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¯ä¸€åˆ‡ä¸è¦ã€‚</li>
                    <li class="about-li"><b>ğŸ§ è‡ªå‹•éŸ³å£°å†ç”Ÿ</b>: å…¥åŠ›ã—ãŸè‹±å˜èªã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ç™ºéŸ³ã§èª­ã¿ä¸Šã’ã€‚</li>
                    <li class="about-li"><b>ğŸ“Š åŠ¹ç‡çš„ãªå¾©ç¿’</b>: ã€Œè¦šãˆãŸã€ã€Œã¾ã ã€ã‚’è‰²åˆ†ã‘ã—ã€è‹¦æ‰‹ãªå˜èªã ã‘ã‚’é‡ç‚¹çš„ã«ã€‚</li>
                    <li class="about-li"><b>ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–</b>: å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒå‹æ‰‹ã«å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‰ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                </ul>
                <h3 class="about-h3">âš ï¸ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®ä»•çµ„ã¿ï¼ˆé‡è¦ï¼‰</h3>
                <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ä¾¿åˆ©ã•ã‚’å„ªå…ˆã™ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰ã§ã¯ãªãã€<span class="about-strong">ä»ŠãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariã‚„Chromeãªã©ï¼‰ã®å†…éƒ¨</span>ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ä»¥ä¸‹ã®ç‚¹ã«ã”æ³¨æ„ãã ã•ã„ã€‚</p>
                <ol class="about-ul">
                    <li class="about-li">ãƒ–ãƒ©ã‚¦ã‚¶ã®<strong>ã€Œé–²è¦§å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼‰ã€</strong>ã‚’è¡Œã†ã¨ã€å˜èªãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚</li>
                    <li class="about-li">ã“ã®ã¾ã¾åˆ¥ã®ã‚¹ãƒãƒ›ã‚„PCã§ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã¯åŒæœŸï¼ˆå…±æœ‰ï¼‰ã•ã‚Œã¾ã›ã‚“ã€‚</li>
                </ol>
                <h3 class="about-h3">ğŸ“² æ©Ÿç¨®å¤‰æ›´ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’ç§»ã—ãŸã„ã¨ãã¯ï¼Ÿ</h3>
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’å®ˆã‚‹ãŸã‚ã€å®šæœŸçš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</p>
                <ol class="about-ul">
                    <li class="about-li">ç”»é¢å³ä¸Šã® <b>[ <i class="ph-bold ph-download-simple"></i> ] ãƒœã‚¿ãƒ³</b>ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ã‚’æŠ¼ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã™ã€‚</li>
                    <li class="about-li">æ–°ã—ã„ç«¯æœ«ã‚„åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ <b>[ <i class="ph-bold ph-upload-simple"></i> ] ãƒœã‚¿ãƒ³</b>ï¼ˆå¾©å…ƒï¼‰ã‚’æŠ¼ã—ã€ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã™ã€‚</li>
                </ol>
                <p style="margin-top:12px;">ã“ã‚Œã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«å¼•ãç¶™ãã“ã¨ãŒã§ãã¾ã™ã€‚</p>
            </div>
        </details>
    </main>

    <div id="create-modal" class="modal-overlay">
        <div class="modal-card" style="height: auto;">
            <h2 class="modal-title">å˜èªå¸³ã®åå‰</h2>
            <input type="text" id="deck-name-input" class="modal-input" placeholder="ä¾‹: ãƒ†ã‚¹ãƒˆå¯¾ç­–" maxlength="20">
            <div class="input-hint">æœ€å¤§20æ–‡å­—</div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeCreateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-modal btn-confirm" onclick="createDeck()">ä½œæˆã™ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 class="modal-title">å¾©å…ƒã™ã‚‹å˜èªå¸³ã‚’é¸æŠ</h2>
            <div class="import-status">
                <span>é¸æŠä¸­: <span id="selected-count">0</span> å†Š</span>
                <span>(ç©ºã: <span id="free-slots">0</span>)</span>
            </div>
            <ul id="import-list" class="import-list">
                </ul>
            <div id="import-limit-warning" class="import-warning">ä¸Šé™ã‚’è¶…ãˆã‚‹ãŸã‚ã“ã‚Œä»¥ä¸Šé¸æŠã§ãã¾ã›ã‚“</div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeImportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="btn-exec-import" class="btn-modal btn-confirm" onclick="executeImport()" disabled>å¾©å…ƒã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        const META_KEY = 'gakuapu_decks_meta', OLD_DATA_KEY = 'gakuapu_my_words', MAX_DECKS = 10, MAX_DECK_NAME_LEN = 20;
        let tempImportData = null; 

        function navigateTo(url) { try { window.location.href = url } catch (e) { alert("ç§»å‹•: " + url) } }
        function sanitizeInput(str) {
            if (!str) return "";
            return String(str).replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
            });
        }
        function escapeHtml(str) { return sanitizeInput(str); }

        document.addEventListener('DOMContentLoaded', () => { migrateOldData(); initSampleData(); renderDecks(); });
        
        function getDecksMeta() { return JSON.parse(localStorage.getItem(META_KEY) || '[]') }
        function saveDecksMeta(list) { localStorage.setItem(META_KEY, JSON.stringify(list)) }

        function migrateOldData() {
            const old = localStorage.getItem(OLD_DATA_KEY);
            if (old) {
                const decks = getDecksMeta();
                if (decks.length === 0) {
                    const id = Date.now();
                    decks.push({ id: id, title: "ã¯ã˜ã‚ã®å˜èªå¸³", createdAt: new Date().toLocaleDateString(), count: JSON.parse(old).length });
                    saveDecksMeta(decks); localStorage.setItem(`gakuapu_deck_${id}`, old);
                }
            }
        }
        function initSampleData() {
            const decks = getDecksMeta();
            if (decks.length === 0) {
                const id = Date.now();
                decks.push({ id: id, title: "ã‚µãƒ³ãƒ—ãƒ« (Fruits)", createdAt: new Date().toLocaleDateString(), count: 3 });
                saveDecksMeta(decks);
                localStorage.setItem(`gakuapu_deck_${id}`, JSON.stringify([
                    { id: id + 1, word: "apple", meaning: "ã‚Šã‚“ã”", status: 2 },
                    { id: id + 2, word: "banana", meaning: "ãƒãƒŠãƒŠ", status: 1 },
                    { id: id + 3, word: "cherry", meaning: "ã•ãã‚‰ã‚“ã¼", status: 0 }
                ]));
            }
        }

        function renderDecks() {
            const container = document.getElementById('deck-list'), countDisp = document.getElementById('deck-count-disp'), decks = getDecksMeta();
            container.innerHTML = '';
            countDisp.innerText = decks.length;

            decks.slice().reverse().forEach(deck => {
                const list = JSON.parse(localStorage.getItem(`gakuapu_deck_${deck.id}`) || '[]');
                let r = 0, y = 0, g = 0;
                list.forEach(w => { const s = w.status !== undefined ? w.status : 2; if (s === 0) g++; else if (s === 1) y++; else r++; });

                const el = document.createElement('div');
                el.className = 'deck-card';
                el.onclick = () => navigateTo(`mywordbook_player.html?id=${deck.id}`);
                
                el.innerHTML = `
                    <div class="deck-header">
                        <div><h3 class="deck-title">${escapeHtml(deck.title)}</h3><div class="deck-meta">${list.length} å˜èª</div></div>
                        <div class="deck-menu">
                            <button class="deck-menu-btn" title="å‰Šé™¤" onclick="deleteDeck(event,${deck.id})"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                    <div class="status-preview">
                        <div class="status-item"><div class="status-dot dot-red"></div>${r}</div>
                        <div class="status-item"><div class="status-dot dot-yellow"></div>${y}</div>
                        <div class="status-item"><div class="status-dot dot-green"></div>${g}</div>
                    </div>
                    <button class="mini-edit-btn" onclick="event.stopPropagation();navigateTo('mywordbook_registration.html?id=${deck.id}')" title="ç·¨é›†"><i class="ph-bold ph-pencil-simple"></i></button>
                `;
                container.appendChild(el);
            });

            const addEl = document.createElement('div');
            if (decks.length < MAX_DECKS) {
                addEl.className = 'deck-card add-card';
                addEl.onclick = openCreateModal;
                addEl.innerHTML = `<i class="ph-bold ph-plus-circle add-icon"></i><span>æ–°ã—ã„å˜èªå¸³</span>`;
            } else {
                addEl.className = 'deck-card add-card-disabled';
                addEl.onclick = () => alert("å˜èªå¸³ã¯æœ€å¤§10å†Šã¾ã§ã§ã™ã€‚\nä½œæˆã™ã‚‹ã«ã¯ä¸è¦ãªå˜èªå¸³ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚");
                addEl.innerHTML = `<i class="ph-bold ph-prohibit add-icon"></i><span>ä¸Šé™(10å†Š)ã§ã™</span><span class="add-text-sub">æ–°è¦ä½œæˆã§ãã¾ã›ã‚“</span>`;
            }
            container.appendChild(addEl);
        }

        const createModal = document.getElementById('create-modal'), input = document.getElementById('deck-name-input');
        function openCreateModal() { if (getDecksMeta().length >= MAX_DECKS) { alert("ä¸Šé™ã§ã™"); return; } createModal.style.display = 'flex'; input.value = ''; input.focus(); }
        function closeCreateModal() { createModal.style.display = 'none'; }
        
        function createDeck() {
            const title = sanitizeInput(input.value.trim());
            if (!title) return; if (title.length > MAX_DECK_NAME_LEN) { alert("åå‰ãŒé•·ã™ãã¾ã™"); return; }
            const decks = getDecksMeta(); const id = Date.now();
            decks.push({ id: id, title: title, createdAt: new Date().toLocaleDateString(), count: 0 });
            saveDecksMeta(decks); localStorage.setItem(`gakuapu_deck_${id}`, '[]');
            navigateTo(`mywordbook_registration.html?id=${id}`);
        }
        
        function deleteDeck(e, id) {
            e.stopPropagation(); if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const decks = getDecksMeta().filter(d => d.id !== id); saveDecksMeta(decks); localStorage.removeItem(`gakuapu_deck_${id}`); renderDecks();
        }

        function exportAllCSV() {
            const decks = getDecksMeta();
            if (decks.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            let csv = '\uFEFFDeck Name,English,Meaning,Status\n';
            let hasData = false;
            decks.forEach(deck => {
                const list = JSON.parse(localStorage.getItem(`gakuapu_deck_${deck.id}`) || '[]');
                if (list.length > 0) hasData = true;
                const deckTitle = (deck.title || '').replace(/"/g, '""');
                list.forEach(i => {
                    const word = (i.word || '').replace(/"/g, '""');
                    const meaning = (i.meaning || '').replace(/"/g, '""');
                    const status = i.status !== undefined ? i.status : 2;
                    csv += `"${deckTitle}","${word}","${meaning}",${status}\n`;
                });
            });
            if (!hasData) { alert("ç™»éŒ²ã•ã‚ŒãŸå˜èªãŒ1ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“"); return; }
            const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
            downloadFile(`all_words_${dateStr}.csv`, csv, 'text/csv;charset=utf-8;');
        }

        function exportBackup() {
            const meta = getDecksMeta(), data = { meta: meta, decks: {} };
            if (meta.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            meta.forEach(d => { const k = `gakuapu_deck_${d.id}`, v = localStorage.getItem(k); if (v) data.decks[k] = JSON.parse(v); });
            const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
            downloadFile(`backup_${dateStr}.json`, JSON.stringify(data, null, 2), 'application/json');
        }
        function downloadFile(name, content, type) {
            const blob = new Blob([content], { type: type }), url = URL.createObjectURL(blob), a = document.createElement('a');
            a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        const importModal = document.getElementById('import-modal'), importList = document.getElementById('import-list'), btnExecImport = document.getElementById('btn-exec-import'), selectedCountEl = document.getElementById('selected-count'), freeSlotsEl = document.getElementById('free-slots'), limitWarningEl = document.getElementById('import-limit-warning');
        function triggerImport() { document.getElementById('import-file').click(); }

        function readBackupFile(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.meta || !data.decks) throw new Error("ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™");
                    tempImportData = data; 
                    openImportModal();
                } catch (err) { alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + err.message); } finally { inputElement.value = ''; }
            };
            reader.readAsText(file);
        }

        function openImportModal() {
            const currentDecks = getDecksMeta();
            const freeSlots = MAX_DECKS - currentDecks.length;
            importList.innerHTML = '';
            tempImportData.meta.forEach((deck, index) => {
                const li = document.createElement('li');
                li.className = 'import-item';
                li.onclick = (e) => { if(e.target.type !== 'checkbox') { const cb = li.querySelector('input[type="checkbox"]'); cb.checked = !cb.checked; updateImportSelection(); } };
                const words = tempImportData.decks[`gakuapu_deck_${deck.id}`] || [];
                li.innerHTML = `<input type="checkbox" class="import-checkbox" data-index="${index}" onchange="updateImportSelection()"><div class="import-info"><span class="import-title">${escapeHtml(deck.title)}</span><span class="import-meta">ç™»éŒ²å˜èªæ•°: ${words.length} / ä½œæˆæ—¥: ${deck.createdAt || '-'}</span></div>`;
                importList.appendChild(li);
            });
            freeSlotsEl.innerText = freeSlots;
            updateImportSelection();
            importModal.style.display = 'flex';
        }

        function updateImportSelection() {
            const selected = document.querySelectorAll('.import-checkbox:checked');
            const currentDecks = getDecksMeta();
            const freeSlots = MAX_DECKS - currentDecks.length;
            selectedCountEl.innerText = selected.length;
            const isValid = selected.length > 0 && selected.length <= freeSlots;
            btnExecImport.disabled = !isValid;
            limitWarningEl.style.display = selected.length > freeSlots ? 'block' : 'none';
        }

        function closeImportModal() { importModal.style.display = 'none'; tempImportData = null; }

        function executeImport() {
            if (!tempImportData) return;
            const checkboxes = document.querySelectorAll('.import-checkbox:checked');
            if (checkboxes.length === 0) return;
            const currentMeta = getDecksMeta();
            let importedCount = 0;
            const baseTime = Date.now();
            checkboxes.forEach((cb, loopIdx) => {
                const index = parseInt(cb.dataset.index);
                const deckMeta = tempImportData.meta[index];
                const oldKey = `gakuapu_deck_${deckMeta.id}`;
                const words = tempImportData.decks[oldKey];
                if (words) {
                    const newId = baseTime + importedCount; 
                    const safeTitle = sanitizeInput(deckMeta.title || "No Title");
                    const safeWords = words.map((w, wIdx) => ({ id: w.id || (baseTime + (importedCount * 10000) + wIdx), word: sanitizeInput(w.word), meaning: sanitizeInput(w.meaning), status: (typeof w.status === 'number') ? w.status : 2 }));
                    currentMeta.push({ id: newId, title: safeTitle, createdAt: new Date().toLocaleDateString(), count: safeWords.length });
                    localStorage.setItem(`gakuapu_deck_${newId}`, JSON.stringify(safeWords));
                    importedCount++;
                }
            });
            saveDecksMeta(currentMeta);
            alert(`${importedCount} ä»¶ã®å˜èªå¸³ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼`);
            closeImportModal();
            renderDecks();
        }
    </script>
</body>
</html>