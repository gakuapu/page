<!DOCTYPE html>
<html lang="ja">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XKL20YHCTB"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-XKL20YHCTB');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>単語登録｜My単語帳</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --bg-body: #F8FAFC; --bg-surface: #FFFFFF; --text-main: #0F172A; --text-sub: #64748B; --border: #E2E8F0; --primary: #3B82F6; --danger: #EF4444; --radius: 18px; }
        
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'M PLUS Rounded 1c', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { 
            background: var(--bg-surface); padding: 14px 20px; border-bottom: 1px solid var(--border); 
            display: grid; grid-template-columns: 40px 1fr 40px; align-items: center; z-index: 100;
        }
        h1 { font-size: 1rem; font-weight: 800; margin: 0; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; transition: color 0.2s; }
        h1:hover { color: var(--primary); }
        
        .header-btn { background: none; border: none; font-size: 1.4rem; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 4px; border-radius: 8px; }
        .header-btn:hover { color: var(--primary); background: #F1F5F9; }

        .container { flex: 1; max-width: 600px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; height: 100%; position: relative; }

        .input-area { background: var(--bg-surface); padding: 16px; border-bottom: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.03); z-index: 10; }
        .input-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        
        input {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px;
            font-size: 1rem; background: #F8FAFC; transition: border 0.2s; font-family: inherit;
        }
        input:focus { outline: none; border-color: var(--primary); background: white; }
        
        .register-btn {
            width: 100%; background: var(--primary); color: white; border: none; padding: 12px;
            border-radius: 12px; font-size: 1rem; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: opacity 0.2s;
        }
        .register-btn:active { opacity: 0.8; transform: translateY(1px); }

        .limit-info { text-align: right; font-size: 0.75rem; color: var(--text-sub); margin-top: 8px; }

        .word-list { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; display: flex; flex-direction: column; gap: 8px; }
        
        .word-item {
            background: white; border: 1px solid var(--border); border-radius: 14px;
            padding: 10px 14px; display: grid; grid-template-columns: 1fr auto; align-items: center;
            transition: all 0.2s; position: relative;
        }
        .word-item:active { transform: scale(0.99); }
        
        .word-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .word-en { font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 700; color: var(--text-main); word-break: break-all; }
        .word-jp { font-size: 0.85rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .word-actions { display: flex; align-items: center; gap: 10px; margin-left: 12px; }
        .action-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #CBD5E1; padding: 4px; }
        .btn-edit:hover { color: var(--primary); }
        .btn-delete:hover { color: var(--danger); }
        .btn-sound:hover { color: var(--primary); }

        /* ステータスマーカー */
        .status-marker {
            width: 10px; height: 10px; border-radius: 50%;
            background: #CBD5E1; cursor: pointer; flex-shrink: 0;
        }
        .st-0 { background: #10B981; } /* 覚えた */
        .st-1 { background: #F59E0B; } /* 不安 */
        .st-2 { background: #EF4444; } /* 未学習 */

        /* 編集モード */
        .edit-mode {
            padding: 12px 14px;
            display: grid; grid-template-columns: 1fr auto; align-items: flex-start; gap: 12px;
        }
        .edit-form { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .edit-form input { 
            padding: 8px 10px; font-size: 0.95rem; border: 1px solid var(--primary);
            border-radius: 8px; background: #F0F9FF;
        }
        .edit-form input:focus { outline: none; border-color: var(--primary); background: white; }
        
        .edit-actions { display: flex; gap: 8px; flex-direction: column; }
        .edit-btn {
            background: var(--primary); color: white; border: none; padding: 8px 12px;
            border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: 600;
            transition: opacity 0.2s;
        }
        .edit-btn:active { opacity: 0.8; }
        
        .cancel-btn {
            background: #E2E8F0; color: var(--text-main); border: none; padding: 8px 12px;
            border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: 600;
            transition: opacity 0.2s;
        }
        .cancel-btn:active { opacity: 0.8; }

        .empty-state { text-align: center; color: var(--text-sub); margin-top: 40px; font-size: 0.9rem; }

        /* 下部固定エリア */
        .bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border); padding: 14px;
            display: flex; justify-content: center; gap: 16px;
        }
        .play-link-btn {
            background: var(--text-main); color: white; padding: 12px 24px;
            border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* タイトル編集用モーダル背景 */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 200; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-dialog {
            background: white; border-radius: 16px; padding: 24px; max-width: 300px;
            width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-dialog h2 { margin-top: 0; font-size: 1.1rem; }
        .modal-dialog input { 
            width: 100%; margin-bottom: 16px; padding: 10px;
            border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;
            font-family: inherit;
        }
        .modal-actions { display: flex; gap: 12px; }
        .modal-actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .modal-save { background: var(--primary); color: white; }
        .modal-cancel { background: #E2E8F0; color: var(--text-main); }
    </style>
</head>

<body>
    <header>
        <button class="header-btn" onclick="navigateTo('mywordbook_list.html')"><i class="ph-bold ph-caret-left"></i></button>
        <h1 id="deck-title-disp" onclick="openTitleEditModal()" title="クリックで編集">単語登録</h1>
        <div style="width:32px;"></div>
    </header>

    <div class="container">
        <div class="input-area">
            <div class="input-row">
                <input type="text" id="input-word" placeholder="英単語 (例: apple)">
                <input type="text" id="input-meaning" placeholder="意味 (例: りんご)">
            </div>
            <button class="register-btn" onclick="addWord()">
                <i class="ph-bold ph-plus-circle"></i> 追加する
            </button>
            <div class="limit-info">登録数: <span id="word-count">0</span> / 100</div>
        </div>

        <div id="word-list" class="word-list"></div>

        <div class="bottom-bar">
            <a href="#" id="play-link" class="play-link-btn">
                <i class="ph-fill ph-play-circle"></i> 学習をはじめる
            </a>
        </div>
    </div>

    <!-- タイトル編集用モーダル -->
    <div class="modal-overlay" id="title-edit-modal">
        <div class="modal-dialog">
            <h2>単語帳名を編集</h2>
            <input type="text" id="modal-title-input" placeholder="新しい名前">
            <div class="modal-actions">
                <button class="modal-save" onclick="saveTitleEdit()">保存</button>
                <button class="modal-cancel" onclick="closeTitleEditModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const deckId = urlParams.get('id');
        const deckKey = `gakuapu_deck_${deckId}`;
        const MAX_WORDS = 100;
        let editingId = null; // 編集中の単語ID

        function navigateTo(url) { window.location.href = url; }

        document.addEventListener('DOMContentLoaded', () => {
            if (!deckId) { alert("エラー: IDがありません"); navigateTo('mywordbook_list.html'); return; }
            
            const meta = JSON.parse(localStorage.getItem('gakuapu_decks_meta') || '[]');
            const deck = meta.find(d => d.id == deckId);
            if (deck) document.getElementById('deck-title-disp').innerText = deck.title;

            document.getElementById('play-link').href = `mywordbook_player.html?id=${deckId}`;
            renderList();
        });

        function getWords() {
            const data = localStorage.getItem(deckKey);
            if (!data) return [];
            const parsed = JSON.parse(data);
            // 古いフォーマット対応: id がない場合は生成
            return parsed.map((item, idx) => ({
                id: item.id || Date.now() + idx,
                word: item.word,
                meaning: item.meaning,
                status: item.status !== undefined ? item.status : 2
            }));
        }
        function saveWords(list) { localStorage.setItem(deckKey, JSON.stringify(list)); updateMetaCount(list.length); }
        
        function updateMetaCount(count) {
            const meta = JSON.parse(localStorage.getItem('gakuapu_decks_meta') || '[]');
            const idx = meta.findIndex(d => d.id == deckId);
            if (idx !== -1) {
                meta[idx].count = count;
                localStorage.setItem('gakuapu_decks_meta', JSON.stringify(meta));
            }
        }

        function renderList() {
            const list = getWords();
            const container = document.getElementById('word-list');
            document.getElementById('word-count').innerText = list.length;
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `<div class="empty-state">まだ単語がありません。<br>上のフォームから追加してください。</div>`;
                return;
            }

            list.slice().reverse().forEach(item => {
                const el = document.createElement('div');
                
                // 編集中の場合は編集フォームを表示
                if (editingId === item.id) {
                    el.className = 'word-item edit-mode';
                    el.innerHTML = `
                        <div class="edit-form">
                            <input type="text" id="edit-word-${item.id}" value="${sanitize(item.word)}" placeholder="英単語">
                            <input type="text" id="edit-meaning-${item.id}" value="${sanitize(item.meaning)}" placeholder="意味">
                        </div>
                        <div class="edit-actions">
                            <button class="edit-btn" onclick="saveEdit(${item.id})">保存</button>
                            <button class="cancel-btn" onclick="cancelEdit()">キャンセル</button>
                        </div>
                    `;
                    // フォーカス設定
                    container.appendChild(el);
                    setTimeout(() => document.getElementById(`edit-word-${item.id}`).focus(), 0);
                } else {
                    // 通常表示
                    el.className = 'word-item';
                    const s = item.status !== undefined ? item.status : 2;
                    const sClass = s === 0 ? 'st-0' : s === 1 ? 'st-1' : 'st-2';
                    
                    el.innerHTML = `
                        <div class="word-info">
                            <div class="word-en">${sanitize(item.word)}</div>
                            <div class="word-jp">${sanitize(item.meaning)}</div>
                        </div>
                        <div class="word-actions">
                            <div class="status-marker ${sClass}" onclick="toggleStatus(${item.id})" title="状態切替"></div>
                            <button class="action-btn btn-edit" onclick="startEdit(${item.id})" title="編集"><i class="ph-bold ph-pencil"></i></button>
                            <button class="action-btn btn-sound" onclick="playOne('${sanitize(item.word)}')" title="発音"><i class="ph-bold ph-speaker-high"></i></button>
                            <button class="action-btn btn-delete" onclick="deleteWord(${item.id})" title="削除"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(el);
                }
            });
        }

        function sanitize(str) { return String(str).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

        function addWord() {
            const enIn = document.getElementById('input-word');
            const jpIn = document.getElementById('input-meaning');
            const en = enIn.value.trim();
            const jp = jpIn.value.trim();

            if (!en || !jp) return;
            const list = getWords();
            if (list.length >= MAX_WORDS) { alert("上限(100単語)です。これ以上登録できません。"); return; }
            if (list.some(w => w.word.toLowerCase() === en.toLowerCase())) { alert("その単語は既に登録されています"); return; }

            list.push({ id: Date.now(), word: en, meaning: jp, status: 2 });
            saveWords(list);
            enIn.value = ''; jpIn.value = ''; enIn.focus();
            renderList();
        }

        function deleteWord(id) {
            if (confirm("この単語を削除しますか？")) {
                const list = getWords().filter(w => w.id !== id);
                saveWords(list);
                editingId = null;
                renderList();
            }
        }

        function toggleStatus(id) {
            const list = getWords();
            const idx = list.findIndex(w => w.id === id);
            if (idx !== -1) {
                const s = list[idx].status === undefined ? 2 : list[idx].status;
                list[idx].status = s === 2 ? 1 : s === 1 ? 0 : 2;
                saveWords(list);
                renderList();
            }
        }

        // 編集モード開始
        function startEdit(id) {
            editingId = id;
            renderList();
        }

        // 編集モード キャンセル
        function cancelEdit() {
            editingId = null;
            renderList();
        }

        // 編集内容保存
        function saveEdit(id) {
            const list = getWords();
            const idx = list.findIndex(w => w.id === id);
            if (idx === -1) return;

            const newWord = document.getElementById(`edit-word-${id}`).value.trim();
            const newMeaning = document.getElementById(`edit-meaning-${id}`).value.trim();

            if (!newWord || !newMeaning) { alert("単語と意味の両方を入力してください"); return; }

            // 重複チェック（自分自身以外で）
            if (list.some(w => w.id !== id && w.word.toLowerCase() === newWord.toLowerCase())) {
                alert("その単語は既に登録されています");
                return;
            }

            list[idx].word = newWord;
            list[idx].meaning = newMeaning;
            saveWords(list);
            editingId = null;
            renderList();
        }

        function playOne(text) {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            speechSynthesis.speak(u);
        }

        // タイトル編集モーダル
        function openTitleEditModal() {
            const currentTitle = document.getElementById('deck-title-disp').innerText;
            document.getElementById('modal-title-input').value = currentTitle;
            document.getElementById('title-edit-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('modal-title-input').focus(), 0);
        }

        function closeTitleEditModal() {
            document.getElementById('title-edit-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function saveTitleEdit() {
            const newTitle = document.getElementById('modal-title-input').value.trim();
            if (!newTitle) { alert("名前を入力してください"); return; }

            const meta = JSON.parse(localStorage.getItem('gakuapu_decks_meta') || '[]');
            const idx = meta.findIndex(d => d.id == deckId);
            if (idx !== -1) {
                meta[idx].title = newTitle;
                localStorage.setItem('gakuapu_decks_meta', JSON.stringify(meta));
                document.getElementById('deck-title-disp').innerText = newTitle;
                closeTitleEditModal();
            }
        }

        // モーダル背景クリックで閉じる
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('title-edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'title-edit-modal') closeTitleEditModal();
            });
        });
    </script>
</body>
</html>