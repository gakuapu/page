<!DOCTYPE html>
<html lang="ja">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XKL20YHCTB"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-XKL20YHCTB');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>単語登録｜My単語帳</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --bg-body: #F8FAFC; --bg-surface: #FFFFFF; --text-main: #0F172A; --text-sub: #64748B; --border: #E2E8F0; --primary: #3B82F6; --danger: #EF4444; --radius: 18px; }
        
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'M PLUS Rounded 1c', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { 
            background: var(--bg-surface); padding: 14px 20px; border-bottom: 1px solid var(--border); 
            display: grid; grid-template-columns: 40px 1fr 40px; align-items: center; z-index: 100;
        }
        h1 { font-size: 1rem; font-weight: 800; margin: 0; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .header-btn { background: none; border: none; font-size: 1.4rem; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 4px; border-radius: 8px; }
        .header-btn:hover { color: var(--primary); background: #F1F5F9; }

        .container { flex: 1; max-width: 600px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; height: 100%; position: relative; }

        .input-area { background: var(--bg-surface); padding: 16px; border-bottom: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.03); z-index: 10; }
        .input-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        
        input {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px;
            font-size: 1rem; background: #F8FAFC; transition: border 0.2s; font-family: inherit;
        }
        input:focus { outline: none; border-color: var(--primary); background: white; }
        
        .register-btn {
            width: 100%; background: var(--primary); color: white; border: none; padding: 12px;
            border-radius: 12px; font-size: 1rem; font-weight: 800; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: opacity 0.2s;
        }
        .register-btn:active { opacity: 0.8; transform: translateY(1px); }

        .limit-info { text-align: right; font-size: 0.75rem; color: var(--text-sub); margin-top: 8px; }

        .word-list { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; display: flex; flex-direction: column; gap: 8px; }
        
        .word-item {
            background: white; border: 1px solid var(--border); border-radius: 14px;
            padding: 10px 14px; display: grid; grid-template-columns: 1fr auto; align-items: center;
            transition: all 0.2s; position: relative;
        }
        .word-item:active { transform: scale(0.99); }
        
        .word-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .word-en { font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 700; color: var(--text-main); word-break: break-all; }
        .word-jp { font-size: 0.85rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .word-actions { display: flex; align-items: center; gap: 10px; margin-left: 12px; }
        .action-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #CBD5E1; padding: 4px; }
        .btn-delete:hover { color: var(--danger); }
        .btn-sound:hover { color: var(--primary); }

        /* ステータスマーカー */
        .status-marker {
            width: 10px; height: 10px; border-radius: 50%;
            background: #CBD5E1; cursor: pointer; flex-shrink: 0;
        }
        .st-0 { background: #10B981; } /* 覚えた */
        .st-1 { background: #F59E0B; } /* 不安 */
        .st-2 { background: #EF4444; } /* 未学習 */

        .empty-state { text-align: center; color: var(--text-sub); margin-top: 40px; font-size: 0.9rem; }

        /* 下部固定エリア */
        .bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border); padding: 14px;
            display: flex; justify-content: center; gap: 16px;
        }
        .play-link-btn {
            background: var(--text-main); color: white; padding: 12px 24px;
            border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>

<body>
    <header>
        <button class="header-btn" onclick="navigateTo('mywordbook_list.html')"><i class="ph-bold ph-caret-left"></i></button>
        <h1 id="deck-title-disp">単語登録</h1>
        <div style="width:32px;"></div>
    </header>

    <div class="container">
        <div class="input-area">
            <div class="input-row">
                <input type="text" id="input-word" placeholder="英単語 (例: apple)">
                <input type="text" id="input-meaning" placeholder="意味 (例: りんご)">
            </div>
            <button class="register-btn" onclick="addWord()">
                <i class="ph-bold ph-plus-circle"></i> 追加する
            </button>
            <div class="limit-info">登録数: <span id="word-count">0</span> / 100</div>
        </div>

        <div id="word-list" class="word-list"></div>

        <div class="bottom-bar">
            <a href="#" id="play-link" class="play-link-btn">
                <i class="ph-fill ph-play-circle"></i> 学習をはじめる
            </a>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const deckId = urlParams.get('id');
        const deckKey = `gakuapu_deck_${deckId}`;
        const MAX_WORDS = 100;

        function navigateTo(url) { window.location.href = url; }

        document.addEventListener('DOMContentLoaded', () => {
            if (!deckId) { alert("エラー: IDがありません"); navigateTo('mywordbook_list.html'); return; }
            
            const meta = JSON.parse(localStorage.getItem('gakuapu_decks_meta') || '[]');
            const deck = meta.find(d => d.id == deckId);
            if (deck) document.getElementById('deck-title-disp').innerText = deck.title;

            document.getElementById('play-link').href = `mywordbook_player.html?id=${deckId}`;
            renderList();
        });

        function getWords() { return JSON.parse(localStorage.getItem(deckKey) || '[]'); }
        function saveWords(list) { localStorage.setItem(deckKey, JSON.stringify(list)); updateMetaCount(list.length); }
        
        function updateMetaCount(count) {
            const meta = JSON.parse(localStorage.getItem('gakuapu_decks_meta') || '[]');
            const idx = meta.findIndex(d => d.id == deckId);
            if (idx !== -1) {
                meta[idx].count = count;
                localStorage.setItem('gakuapu_decks_meta', JSON.stringify(meta));
            }
        }

        function renderList() {
            const list = getWords();
            const container = document.getElementById('word-list');
            document.getElementById('word-count').innerText = list.length;
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `<div class="empty-state">まだ単語がありません。<br>上のフォームから追加してください。</div>`;
                return;
            }

            list.slice().reverse().forEach(item => {
                const el = document.createElement('div');
                el.className = 'word-item';
                const s = item.status !== undefined ? item.status : 2;
                const sClass = s === 0 ? 'st-0' : s === 1 ? 'st-1' : 'st-2';
                
                el.innerHTML = `
                    <div class="word-info">
                        <div class="word-en">${sanitize(item.word)}</div>
                        <div class="word-jp">${sanitize(item.meaning)}</div>
                    </div>
                    <div class="word-actions">
                        <div class="status-marker ${sClass}" onclick="toggleStatus(${item.id})" title="状態切替"></div>
                        <button class="action-btn btn-sound" onclick="playOne('${sanitize(item.word)}')" title="発音"><i class="ph-bold ph-speaker-high"></i></button>
                        <button class="action-btn btn-delete" onclick="deleteWord(${item.id})" title="削除"><i class="ph-bold ph-trash"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function sanitize(str) { return String(str).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

        function addWord() {
            const enIn = document.getElementById('input-word');
            const jpIn = document.getElementById('input-meaning');
            const en = enIn.value.trim();
            const jp = jpIn.value.trim();

            if (!en || !jp) return;
            const list = getWords();
            if (list.length >= MAX_WORDS) { alert("上限(100単語)です。これ以上登録できません。"); return; }
            if (list.some(w => w.word.toLowerCase() === en.toLowerCase())) { alert("その単語は既に登録されています"); return; }

            list.push({ id: Date.now(), word: en, meaning: jp, status: 2 });
            saveWords(list);
            enIn.value = ''; jpIn.value = ''; enIn.focus();
            renderList();
        }

        function deleteWord(id) {
            if (confirm("この単語を削除しますか？")) {
                const list = getWords().filter(w => w.id !== id);
                saveWords(list);
                renderList();
            }
        }

        function toggleStatus(id) {
            const list = getWords();
            const idx = list.findIndex(w => w.id === id);
            if (idx !== -1) {
                const s = list[idx].status === undefined ? 2 : list[idx].status;
                list[idx].status = s === 2 ? 1 : s === 1 ? 0 : 2;
                saveWords(list);
                renderList();
            }
        }

        function playOne(text) {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            speechSynthesis.speak(u);
        }
    </script>
</body>
</html>